{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
  "packages": [
    "ruby@3.4.8",
    "nodejs@18.17.0",
    "yarn@1.22.19",
    "awscli2@latest",

    "postgresql@15.7",
    "redis@latest",

    "libyaml@latest",
    "libyaml.dev",
    "pkg-config@latest",
    "gcc@latest",
    "gnumake@latest",

    "git@latest",
    "chromedriver@latest",
    "bash@latest",
    "zsh@latest"
  ],
  "env": {
    "DEVBOX": "1",

    "GEM_HOME": "$PWD/.devbox/virtenv/ruby/gems",
    "GEM_PATH": "$PWD/.devbox/virtenv/ruby/gems",
    "PATH": "$PWD/.devbox/virtenv/ruby/gems/bin:$PWD/.devbox/virtenv/ruby/bin:$PWD/.devbox/nix/profile/default/bin:$PATH",

    "BUNDLER_VERSION": "2.5.9",
    "TMPDIR": "$PWD/.tmp",

    "PKG_CONFIG_PATH": "$PWD/.devbox/nix/profile/default/lib/pkgconfig:$PWD/.devbox/nix/profile/default/share/pkgconfig",
    "BUNDLE_BUILD__PSYCH": "--with-libyaml-dir=$PWD/.devbox/nix/profile/default --with-pkg-config=$PWD/.devbox/nix/profile/default/bin/pkg-config",

    "PGDATA": "$PWD/.postgres/data",
    "PGHOST": "$PWD/.postgres",
    "PGPORT": "5432",
    "PGUSER": "$USER",
    "PGDATABASE": "pdc_describe_dev",
    "PGPASSWORD": "",

    "APP_DB_PORT": "5432",
    "APP_DB_HOST": "$PWD/.postgres",
    "APP_DB_USERNAME": "$USER",
    "APP_DB_PASSWORD": "",
    "APP_DB": "pdc_describe_dev",

    "DEVBOX_PGHOST": "$PWD/.postgres",
    "DEVBOX_PGPORT": "5432",
    "DEVBOX_PGUSER": "$USER",
    "DEVBOX_PGDATABASE": "pdc_describe_dev",
    "DEVBOX_PGPASSWORD": "",

    "REDIS_DIR": "$PWD/.redis",
    "REDIS_PORT": "6379",
    "REDIS_URL": "redis://127.0.0.1:6379/0"
  },
  "shell": {
    "init_hook": ["mkdir -p \"$PWD/.tmp\" \"$PWD/.postgres\" \"$PWD/.redis\""],
    "scripts": {
      "setup": [
        "bash -lc 'set -e; mkdir -p \"$TMPDIR\" \"$GEM_HOME\"; bin/devbox-bundle install; yarn install'"
      ],

      "postgres-start": "bash -c 'set -e; mkdir -p \"$PGHOST\" \"$(dirname \"$PGDATA\")\"; if [ ! -f \"$PGDATA/PG_VERSION\" ]; then mkdir -p \"$PGDATA\"; initdb -D \"$PGDATA\" -A trust; fi; pg_ctl -D \"$PGDATA\" -l \"$PGHOST/postgres.log\" -o \"-k \\\"$PGHOST\\\" -p $PGPORT -c listen_addresses=\" start'",
      "postgres-stop": "bash -c 'pg_ctl -D \"$PGDATA\" -m fast stop || true'",
      "postgres-status": "bash -c 'pg_ctl -D \"$PGDATA\" status || true'",
      "postgres-log": "bash -c 'tail -200 \"$PGHOST/postgres.log\" 2>/dev/null || true'",

      "postgres-ensure": "bash -c '\nset -e\nmkdir -p \"$PGHOST\" \"$(dirname \"$PGDATA\")\"\nif [ ! -f \"$PGDATA/PG_VERSION\" ]; then\n  mkdir -p \"$PGDATA\"\n  initdb -D \"$PGDATA\" -A trust\nfi\npg_isready -h \"$PGHOST\" -p \"$PGPORT\" >/dev/null 2>&1 && exit 0\nPIDFILE=\"$PGDATA/postmaster.pid\"\nif [ -f \"$PIDFILE\" ]; then\n  PID=$(head -1 \"$PIDFILE\" || true)\n  if [ -n \"$PID\" ] && ! kill -0 \"$PID\" 2>/dev/null; then\n    rm -f \"$PIDFILE\"\n  fi\nfi\npg_ctl -D \"$PGDATA\" -l \"$PGHOST/postgres.log\" -o \"-p $PGPORT -k $PGHOST -c listen_addresses=\" start\nfor i in $(seq 1 50); do\n  pg_isready -h \"$PGHOST\" -p \"$PGPORT\" >/dev/null 2>&1 && exit 0\n  sleep 0.1\ndone\necho \"Postgres did not become ready\" >&2\ntail -200 \"$PGHOST/postgres.log\" || true\nexit 1\n'",

      "db-create": "bash -c 'set -e; devbox run postgres-ensure >/dev/null; bin/devbox-bundle exec rails db:create'",
      "db-migrate": "bash -c 'set -e; devbox run postgres-ensure >/dev/null; bin/devbox-bundle exec rails db:migrate'",
      "db-prepare": "bash -c 'set -e; devbox run postgres-ensure >/dev/null; bin/devbox-bundle exec rails db:prepare'",

      "redis-start": "bash -c 'set -e; mkdir -p \"$REDIS_DIR\"; if [ -f \"$REDIS_DIR/redis.pid\" ] && kill -0 \"$(cat \"$REDIS_DIR/redis.pid\")\" 2>/dev/null; then exit 0; fi; redis-server --port \"$REDIS_PORT\" --bind 127.0.0.1 --dir \"$REDIS_DIR\" --dbfilename dump.rdb --appendonly yes --logfile \"$REDIS_DIR/redis.log\" --pidfile \"$REDIS_DIR/redis.pid\" --daemonize yes'",
      "redis-stop": "bash -c 'test -f \"$REDIS_DIR/redis.pid\" && redis-cli -p \"$REDIS_PORT\" shutdown >/dev/null 2>&1 || true; rm -f \"$REDIS_DIR/redis.pid\" || true'",
      "redis-status": "bash -c 'redis-cli -p \"$REDIS_PORT\" ping 2>/dev/null || true'",
      "redis-log": "tail -200 \"$REDIS_DIR/redis.log\" 2>/dev/null || true",
      "redis-ensure": "bash -c 'redis-cli -p \"$REDIS_PORT\" ping >/dev/null 2>&1 && exit 0; devbox run redis-start >/dev/null; for i in $(seq 1 50); do redis-cli -p \"$REDIS_PORT\" ping >/dev/null 2>&1 && exit 0; sleep 0.1; done; echo \"Redis did not become ready\" >&2; devbox run redis-log || true; exit 1'",

      "services-up": "bash -c 'devbox run postgres-ensure >/dev/null && devbox run redis-ensure >/dev/null'",
      "services-down": "bash -c 'devbox run redis-stop >/dev/null || true; devbox run postgres-stop >/dev/null || true'",

      "rails": "bash -c 'set -e; devbox run services-up >/dev/null; bin/devbox-bundle exec rails server -p 3000 -b 127.0.0.1'",
      "sidekiq": "bash -c 'set -e; devbox run services-up >/dev/null; bin/devbox-bundle exec sidekiq'",
      "test": "bash -c 'set -e; devbox run services-up >/dev/null; bin/devbox-bundle exec rspec'",

      "zsh": "zsh -l"
    }
  }
}
